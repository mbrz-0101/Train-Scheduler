<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
    crossorigin="anonymous">
  <link rel="stylesheet" href="scheduler-style.css" type="text/css">
  <script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>
  <title>Document</title>
</head>

<body>
  <div class="container-fluid" style="width: 100%">
    <div class="row">
      <div class="col-md-12 text-center" id="jumbotron">
        <h1>Train Scheduler</h1>
        <h4>A Comprehensive Directory of Trains and their Schedules</h4>
      </div>
    </div>

    <div class="container">
      <div class="row">

        <div class="row">
          <div class="col-md-12 card-row">
            <p>
              Current Train Schedule
            </p>
          </div>
        </div>

        <div class="row">
          <div class="col-md-12">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th scope="col">Train Name</th>
                  <th scope="col">Destination</th>
                  <th scope="col">Frequency (min)</th>
                  <th scope="col">Next Arrival</th>
                  <th scope="col">Minutes Away</th>
                </tr>
              </thead>
              <tbody>

              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>


    <div class="container">
      <div class="row">

        <div class="row">
          <div class="col-md-12 card-row">
            <p>
              Add Train
            </p>
          </div>
        </div>

        <div class="row">
          <div class="col-md-12">
            <form>
              <div class="form-group">
                <label for="exampleFormControlInput1">Train Name</label>
                <input type="text" class="form-control" id="name-input">
              </div>
              <div class="form-group">
                <label for="exampleFormControlInput1">Destination</label>
                <input type="text" class="form-control" id="destination-input">
              </div>
              <div class="form-group">
                <label for="exampleFormControlInput1">First Train Time (HH:mm - military time)</label>
                <input type="text" class="form-control" id="start-time-input">
              </div>
              <div class="form-group">
                <label for="exampleFormControlInput1">Frequency (min)</label>
                <input type="text" class="form-control" id="frequency-input">
              </div>
              <div class="form-group">
                <button type="submit" class="btn btn-primary" id="add-train">Submit</button>
              </div>
            </form>
          </div>
        </div>

      </div>
    </div>


    <script src="http://code.jquery.com/jquery-3.3.1.slim.js" integrity="sha256-fNXJFIlca05BIO2Y5zh1xrShK3ME+/lYZ0j+ChxX2DA="
      crossorigin="anonymous"></script>
    <script src="moment.js"></script>
    <script>
      var config = {
        apiKey: "AIzaSyDVCJJXeaRGHfIB5NjHXc2ErOLmUmloDLw",
        authDomain: "first-firebase-pro-b5ceb.firebaseapp.com",
        databaseURL: "https://first-firebase-pro-b5ceb.firebaseio.com",
        projectId: "first-firebase-pro-b5ceb",
        storageBucket: "first-firebase-pro-b5ceb.appspot.com",
        messagingSenderId: "233254861530"
      };

      firebase.initializeApp(config);

      // Create a variable to reference the database.
      var database = firebase.database();

      let name = "";
      let destination = "";
      let firstTrainTime = "";
      let frequency = 0;

      $("#add-train").on('click', function (event) {
        event.preventDefault();

        name = $("#name-input").val().trim();
        destination = $("#destination-input").val().trim();
        firstTrainTime = $("#start-time-input").val().trim();
        frequency = $("#frequency-input").val().trim();

        database.ref().push({
          name: name,
          destination: destination,
          firstTrainTime: firstTrainTime,
          frequency: frequency,
          dateAdded: firebase.database.ServerValue.TIMESTAMP
        });

      });

      database.ref().orderByChild("name").on("child_added", function (childSnapshot) {

        console.log(childSnapshot);

        let nRow = $("<tr>");
        let ntd1 = $("<td>");
        let ntd2 = $("<td>");
        let ntd3 = $("<td>");
        let ntd4 = $("<td>");
        let ntd5 = $("<td>");

        let nextArrival = moment(childSnapshot.val().frequency).format("HH:mm");
        console.log(typeof nextArrival);
        let minutesAway = moment().diff(moment(childSnapshot.val().startDate, "DDMMYY"), 'months');

        ntd1.text(childSnapshot.val().name);
        ntd2.text(childSnapshot.val().destination);
        ntd3.text(childSnapshot.val().frequency);
        ntd4.text(nextArrival);
        ntd5.text(minutesAway);

        nRow.append(ntd1);
        nRow.append(ntd2);
        nRow.append(ntd3);
        nRow.append(ntd4);
        nRow.append(ntd5);

        $("tbody").append(nRow);

      }, function (errorObject) {
        console.log("Errors handled: " + errorObject.code);
      });


    </script>
</body>

</html>